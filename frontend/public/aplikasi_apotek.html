<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Apotek - Verifikasi Resep Saraf</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        /* --- 1. MODERN BACKGROUND & LAYOUT --- */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a; /* Dark Base for Contrast */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Aurora Background */
        .aurora-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            z-index: -2;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }

        /* --- 2. SEARCH CARD (GLASSMORPHISM) --- */
        .search-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .brand-logo {
            font-size: 1.8rem;
            margin: 0;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .subtitle { color: #64748b; margin-top: 5px; margin-bottom: 30px; font-size: 0.9rem; font-weight: 500; }

        .input-group { position: relative; margin-bottom: 25px; text-align: left; }
        .input-label { 
            font-size: 0.75rem; font-weight: 800; color: #475569; margin-bottom: 8px; 
            display: block; text-transform: uppercase; letter-spacing: 1px; 
        }
        
        input {
            width: 100%;
            padding: 16px 20px;
            background: #f1f5f9;
            border: 2px solid transparent;
            border-radius: 16px;
            font-size: 1rem;
            color: #1e293b;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
            font-family: 'Space Mono', monospace; /* Font teknis untuk input ID */
        }
        input:focus { 
            background: white; 
            border-color: #10b981; 
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); 
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            margin-top: 10px;
            letter-spacing: 0.5px;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(16, 185, 129, 0.5); }
        button:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; transform: none; }

        /* --- 3. TICKET RESULT (RECEIPT STYLE PRO) --- */
        .ticket-wrapper {
            display: none;
            width: 100%;
            max-width: 400px;
            /* Efek Bayangan Realistis Melengkung */
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.4)); 
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            margin: 20px;
        }

        @keyframes slideUp { from { transform: translateY(100px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .ticket {
            background: #fff;
            width: 100%;
            padding: 0;
            position: relative;
            /* Potongan Kertas Bergerigi (Serrated Edge) CSS */
            background-image: linear-gradient(135deg, transparent 75%, #fff 75%), linear-gradient(45deg, transparent 75%, #fff 75%);
            background-position: bottom;
            background-size: 20px 20px;
            background-repeat: repeat-x;
            border-radius: 10px 10px 0 0;
            padding-bottom: 30px; /* Space for jagged bottom */
            overflow: hidden;
        }
        /* Fix background putih di atas jagged edge */
        .ticket::after {
            content: "";
            position: absolute;
            bottom: 10px; left: 0; width: 100%; height: 20px;
            background: white;
            z-index: 0;
        }

        /* Ticket Header (Teal Stripe) */
        .ticket-header { 
            background: #064e3b; 
            padding: 30px 20px; 
            text-align: center; 
            color: white;
            position: relative;
            z-index: 1;
        }
        .clinic-name { font-weight: 900; font-size: 1.2rem; margin: 0; letter-spacing: 2px; }
        .verified-badge { 
            display: inline-block; 
            background: #10b981; color: #fff; 
            padding: 4px 12px; border-radius: 4px; 
            font-size: 0.65rem; font-weight: 800; margin-top: 10px;
            letter-spacing: 1px;
        }

        /* Ticket Body */
        .ticket-body { 
            padding: 30px; 
            color: #334155; 
            font-family: 'Space Mono', monospace; /* Font struk */
            font-size: 0.85rem;
            position: relative;
            z-index: 1;
        }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .info-label { color: #94a3b8; text-transform: uppercase; font-size: 0.7rem; }
        .info-val { font-weight: 700; text-align: right; color: #1e293b; max-width: 60%; }

        .divider { 
            border-bottom: 2px dashed #cbd5e1; 
            margin: 25px 0; 
            position: relative;
        }
        /* Potongan Setengah Lingkaran di Kiri & Kanan Divider */
        .divider::before, .divider::after {
            content: "";
            position: absolute;
            top: -10px;
            width: 20px; height: 20px;
            background: #0f172a; /* Warna sama dengan body background */
            border-radius: 50%;
        }
        .divider::before { left: -40px; }
        .divider::after { right: -40px; }

        /* Prescription Section */
        .rx-title { 
            font-weight: 800; font-size: 0.9rem; margin-bottom: 15px; 
            display: flex; justify-content: space-between; align-items: center;
            color: #0f172a; letter-spacing: -0.5px; font-family: 'Plus Jakarta Sans', sans-serif;
        }
        .rx-content { 
            white-space: pre-wrap; 
            line-height: 1.7; 
            color: #059669; /* Green Text */
            font-weight: 700;
            background: #ecfdf5;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #10b981;
        }
        
        .blur-content { filter: blur(5px); user-select: none; transition: 0.3s; opacity: 0.5; }
        .privacy-toggle { font-size: 0.7rem; color: #3b82f6; cursor: pointer; text-decoration: none; font-weight: 600; }

        /* Ticket Footer */
        .ticket-footer { text-align: center; margin-top: 30px; position: relative; z-index: 1; }
        .qr-placeholder { 
            width: 100px; height: 100px; margin: 0 auto 15px;
            mix-blend-mode: multiply;
        }
        .sign-text { font-size: 0.7rem; color: #94a3b8; margin: 0; font-style: italic; }

        /* --- LOADING & ERROR --- */
        .loading-overlay { display: none; margin: 20px auto; text-align: center; color: white; }
        .heartbeat-icon { font-size: 4rem; color: #f43f5e; animation: heartbeat 1.5s infinite; text-shadow: 0 0 30px rgba(244, 63, 94, 0.6); }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.3); } 30% { transform: scale(1); } 45% { transform: scale(1.15); } 60% { transform: scale(1); } }

        .error-msg { background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 12px; text-align: center; margin-top: 20px; display: none; font-weight: 700; border: 1px solid #fca5a5; font-size: 0.9rem; }

        /* Action Link */
        .back-link {
            display: block;
            margin-top: 25px;
            color: #64748b;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .back-link:hover { color: white; }

    </style>
</head>
<body>

    <!-- Background Orbs -->
    <div class="aurora-bg"></div>
    <div class="orb" style="top: 10%; left: 10%; width: 300px; height: 300px; background: #10b981;"></div>
    <div class="orb" style="bottom: 10%; right: 10%; width: 400px; height: 400px; background: #3b82f6;"></div>

    <!-- 1. SEARCH FORM CARD -->
    <div class="search-card" id="searchPanel">
        <div style="font-size: 3rem; margin-bottom: 10px;">üíä</div>
        <h1 class="brand-logo">Apotek Portal</h1>
        <p class="subtitle">Verifikasi Keaslian Resep Digital</p>

        <div class="input-group">
            <label class="input-label">Kunci Akses (API Key)</label>
            <input type="text" id="apiKey" placeholder="cth: klinik_xyz123...">
        </div>

        <div class="input-group">
            <label class="input-label">ID Resep / Transaksi</label>
            <input type="text" id="noRm" placeholder="cth: RSP-1001" value="RSP-1">
        </div>

        <button onclick="cekResep()" id="btnCek">üîç VERIFIKASI SEKARANG</button>
        <div id="errorBox" class="error-msg"></div>
    </div>

    <!-- 2. LOADING ANIMATION -->
    <div class="loading-overlay" id="loadingBox">
        <div class="heartbeat-icon">‚ù§Ô∏è</div>
        <p style="font-weight: 700; margin-top: 20px; letter-spacing: 1px;">MENGHUBUNGKAN KE KLINIK...</p>
    </div>

    <!-- 3. TICKET RESULT (RECEIPT) -->
    <div id="resultBox" class="ticket-wrapper">
        <div class="ticket">
            
            <div class="ticket-header">
                <div class="clinic-name">NOVACARE CLINIC</div>
                <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 5px;">Digital Health System Integration</div>
                <div class="verified-badge">‚úì RESEP VALID</div>
            </div>

            <div class="ticket-body">
                <div class="info-row">
                    <span class="info-label">ID TRANSAKSI</span>
                    <span class="info-val" id="outRm">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">TANGGAL TERBIT</span>
                    <span class="info-val" id="outTanggal">-</span>
                </div>
                
                <div class="divider"></div>

                <div class="info-row">
                    <span class="info-label">NAMA PASIEN</span>
                    <span class="info-val" id="outPasien">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">DOKTER PERESEP</span>
                    <span class="info-val" id="outDokter">-</span>
                </div>

                <div class="divider"></div>

                <div class="rx-title"><span>RINCIAN OBAT (Rx)</span></div>
                <div class="rx-content" id="outResep"></div>

                <div class="divider"></div>

                <div class="rx-title">
                    <span>DIAGNOSA KLINIS</span>
                    <span class="privacy-toggle" onclick="toggleBlur()">üëÅ Tampilkan</span>
                </div>
                <div class="rx-content blur-content" id="outDiagnosis" style="color: #64748b; background: #f8fafc; border: 1px solid #e2e8f0; font-weight: 400;"></div>
                
                <div id="outCatatan" style="font-size: 0.75rem; color: #94a3b8; margin-top: 15px; font-style: italic; text-align: center;"></div>
            </div>

            <div class="ticket-footer">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=NOVACARE-VALID" class="qr-placeholder" alt="QR">
                <p class="sign-text">Digital Signature: Verified by System</p>
                <div style="margin-top: 5px; font-size: 0.6rem; color: #cbd5e1;">2024 ¬© Novacare Integration</div>
            </div>
        </div>

        <div style="text-align: center;">
            <a onclick="resetBtn()" class="back-link">‚Üê Periksa Resep Lain</a>
        </div>
    </div>

    <script>
        const BACKEND_URL = "http://localhost:3009"; 

        async function cekResep() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const noRm = document.getElementById('noRm').value.trim();
            
            const searchPanel = document.getElementById('searchPanel');
            const resultBox = document.getElementById('resultBox');
            const errorBox = document.getElementById('errorBox');
            const loadingBox = document.getElementById('loadingBox');

            errorBox.style.display = 'none';
            searchPanel.style.display = 'none';
            loadingBox.style.display = 'block'; 

            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/partners/resep/${noRm}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey }
                });

                const resJson = await response.json();
                await new Promise(r => setTimeout(r, 1500)); // Animasi delay

                if (!response.ok) throw new Error(resJson.message || "Gagal memverifikasi resep.");

                const data = resJson.data; 

                // Mapping Data
                document.getElementById('outTanggal').innerText = data.tanggal_periksa ? 
                    new Date(data.tanggal_periksa).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' }).toUpperCase() : "-";
                
                document.getElementById('outRm').innerText = data.id_resep;
                document.getElementById('outPasien').innerText = data.nama_pasien.toUpperCase();
                document.getElementById('outDokter').innerText = `${data.nama_dokter} (${data.spesialisasi})`;
                
                document.getElementById('outResep').innerText = data.resep_obat;
                document.getElementById('outDiagnosis').innerText = data.diagnosa;
                document.getElementById('outCatatan').innerText = data.catatan_tambahan ? `"${data.catatan_tambahan}"` : "";

                loadingBox.style.display = 'none';
                resultBox.style.display = 'block';

            } catch (error) {
                loadingBox.style.display = 'none';
                searchPanel.style.display = 'block';
                showError(error.message);
            }
        }

        function showError(msg) {
            const errorBox = document.getElementById('errorBox');
            errorBox.innerText = "‚ö†Ô∏è " + msg;
            errorBox.style.display = 'block';
        }

        function resetBtn() {
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('searchPanel').style.display = 'block';
            document.getElementById('noRm').value = '';
            document.getElementById('errorBox').style.display = 'none';
        }

        function toggleBlur() {
            const el = document.getElementById('outDiagnosis');
            const btn = document.querySelector('.privacy-toggle');
            if (el.classList.contains('blur-content')) {
                el.classList.remove('blur-content');
                btn.innerText = "üôà Sembunyikan";
            } else {
                el.classList.add('blur-content');
                btn.innerText = "üëÅ Tampilkan";
            }
        }
    </script>
</body>
</html>